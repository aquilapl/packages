From 674d619de446760ee84f6728aa09e69dd2448b4e Mon Sep 17 00:00:00 2001
From: Zach Bacon <zachbacon@vba-m.com>
Date: Fri, 3 Nov 2023 12:00:05 -0400
Subject: [PATCH] freefilesync: enable wxwidgets-gtk3 support

Signed-off-by: Zach Bacon <zachbacon@vba-m.com>
---
 FreeFileSync/Source/Makefile                     | 4 ++--
 FreeFileSync/Source/RealTimeSync/Makefile        | 4 ++--
 FreeFileSync/Source/RealTimeSync/application.cpp | 3 ---
 FreeFileSync/Source/afs/sftp.cpp                 | 5 ++++-
 FreeFileSync/Source/application.cpp              | 3 ---
 FreeFileSync/Source/base/icon_loader.cpp         | 2 +-
 6 files changed, 9 insertions(+), 12 deletions(-)

diff --git a/FreeFileSync/Source/Makefile b/FreeFileSync/Source/Makefile
index f49b9ff..97facdf 100644
--- a/FreeFileSync/Source/Makefile
+++ b/FreeFileSync/Source/Makefile
@@ -17,9 +17,9 @@ LDFLAGS += `pkg-config --libs   libcurl`
 CXXFLAGS  += `pkg-config --cflags libssh2`
 LDFLAGS += `pkg-config --libs   libssh2`
 
-CXXFLAGS  += `pkg-config --cflags gtk+-2.0`
+CXXFLAGS  += `pkg-config --cflags gtk+-3.0`
 #treat as system headers so that warnings are hidden:
-CXXFLAGS  += -isystem/usr/include/gtk-2.0
+CXXFLAGS  += -isystem/usr/include/gtk-3.0
 
 #support for SELinux (optional)
 SELINUX_EXISTING=$(shell pkg-config --exists libselinux && echo YES)
diff --git a/FreeFileSync/Source/RealTimeSync/Makefile b/FreeFileSync/Source/RealTimeSync/Makefile
index bac4de3..ea7f58b 100644
--- a/FreeFileSync/Source/RealTimeSync/Makefile
+++ b/FreeFileSync/Source/RealTimeSync/Makefile
@@ -8,9 +8,9 @@ CXXFLAGS += -std=c++23 -pipe -DWXINTL_NO_GETTEXT_MACRO -I../../.. -I../../../zen
 LDFLAGS += -s -no-pie `wx-config --libs std, aui, richtext --debug=no` -pthread
 
 #Gtk - support "no button border"
-CXXFLAGS  += `pkg-config --cflags gtk+-2.0`
+CXXFLAGS  += `pkg-config --cflags gtk+-3.0`
 #treat as system headers so that warnings are hidden:
-CXXFLAGS  += -isystem/usr/include/gtk-2.0
+CXXFLAGS  += -isystem/usr/include/gtk-3.0
 
 cppFiles=
 cppFiles+=application.cpp
diff --git a/FreeFileSync/Source/RealTimeSync/application.cpp b/FreeFileSync/Source/RealTimeSync/application.cpp
index df14800..b2601a2 100644
--- a/FreeFileSync/Source/RealTimeSync/application.cpp
+++ b/FreeFileSync/Source/RealTimeSync/application.cpp
@@ -211,9 +211,6 @@ int Application::OnRun()
 {
     try
     {
-#if wxUSE_EXCEPTIONS
-#error why is wxWidgets uncaught exception handling enabled!?
-#endif
         [[maybe_unused]] const int rc = wxApp::OnRun();
     }
     catch (const std::bad_alloc& e) //the only kind of exception we don't want crash dumps for
diff --git a/FreeFileSync/Source/afs/sftp.cpp b/FreeFileSync/Source/afs/sftp.cpp
index 795b5a0..3c5bdf1 100644
--- a/FreeFileSync/Source/afs/sftp.cpp
+++ b/FreeFileSync/Source/afs/sftp.cpp
@@ -17,7 +17,10 @@
 #include "init_curl_libssh2.h"
 #include "ftp_common.h"
 #include "abstract_impl.h"
-    #include <poll.h>
+#include <poll.h>
+
+#define MAX_SFTP_OUTGOING_SIZE 30000
+#define MAX_SFTP_READ_SIZE 30000
 
 using namespace zen;
 using namespace fff;
diff --git a/FreeFileSync/Source/application.cpp b/FreeFileSync/Source/application.cpp
index 38f677d..45571d9 100644
--- a/FreeFileSync/Source/application.cpp
+++ b/FreeFileSync/Source/application.cpp
@@ -245,9 +245,6 @@ int Application::OnRun()
 {
     try
     {
-#if wxUSE_EXCEPTIONS
-#error why is wxWidgets uncaught exception handling enabled!?
-#endif
         [[maybe_unused]] const int rc = wxApp::OnRun();
     }
     catch (const std::bad_alloc& e) //the only kind of exception we don't want crash dumps for
diff --git a/FreeFileSync/Source/base/icon_loader.cpp b/FreeFileSync/Source/base/icon_loader.cpp
index 67a0352..8592b76 100644
--- a/FreeFileSync/Source/base/icon_loader.cpp
+++ b/FreeFileSync/Source/base/icon_loader.cpp
@@ -227,7 +227,7 @@ FileIconHolder fff::getFileIcon(const Zstring& filePath, int maxSize) //throw Sy
     //the remaining icon types won't block!
     assert(GDK_IS_PIXBUF(gicon) || G_IS_THEMED_ICON(gicon) || G_IS_EMBLEMED_ICON(gicon));
 
-    ::g_object_ref(gicon);                 //pass ownership
+    g_object_ref(gicon);                 //pass ownership
     return FileIconHolder(gicon, maxSize); //
 
 }
-- 
2.42.0

